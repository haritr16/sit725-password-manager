<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./css/password-view.css">
    <title>Password Manager</title>
</head>

<body>
    <div class="navigation">
        <nav class="btn-set1">
            <input class="action-btn logout" type="button" onclick="confirmLogout()">
            <input class="action-btn add-record" type="button">
            <input class="action-btn remove-record" type="button">
            <input class="action-btn fetch-records" type="button" onclick="showFetchRecordsWindow()" value="Fetch Records">
           
            <input class="action-btn menu-button" type="button">
        </nav>
    </div>
    </div>
    <div class="table-container">
        <table class="styled-table">
            <thead>
                <tr>
                    <th class="selection">Selection</th>
                    <th>Platform</th>
                    <th>Username</th>
                    <th>Password</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="add-wall" style="display: none;">
        <div class="add-window">
            <h2>Add a record</h2>
            <form id="addRecordForm" action="/add-record" method="post" onsubmit="return addRecord1(event)">
                <input class="add-inputs add-platform" name="platform" type="text" required placeholder="Platform" >
                <input class="add-inputs add-username" name="username" type="text" required placeholder="Username" >
                <input class="add-inputs add-password" name="password" type="password" required placeholder="Password" >
                <input class="add-inputs add-retype-password" name="retypePassword" type="password" required placeholder="Re-type Password" >
                <input class="add-inputs add-submit" type="submit" value="Confirm">
                <input class="add-cancel" type="button" value="X" onclick="hideAddRecordWindow()">
            </form>
        </div>
    </div>
    <div class="fetch-records-wall" style="display: none;">
        <div class="fetch-records-window">
            <h2>Fetch Records</h2>
            <form id="fetchRecordsForm" onsubmit="return fetchRecordsByUsername(event)">
                <input class="fetch-inputs fetch-username" name="username" type="text" required placeholder="Username" autocomplete="username">
                <input class="fetch-inputs fetch-submit" type="submit" value="Fetch">
                <input class="fetch-cancel" type="button" value="X" onclick="hideFetchRecordsWindow()">
            </form>
        </div>
    </div>
    <script>
        async function addRecord1(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            console.log('Form data:', data);  // Log form data for debugging

            if (data.password !== data.retypePassword) {
                alert('Passwords do not match');
                return false;
            }

            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        platform: data.platform,
                        username: data.username,
                        password: data.password
                    })
                });

                const result = await response.json();
                console.log('Server response:', result);  // Log server response for debugging

                if (response.ok) {
                    alert(result.message);
                    form.reset();
                    hideAddRecordWindow();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error adding record:', error);
                alert('An error occurred while adding the record.');
            }
        }
        async function fetchRecordsByUsername(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`/get-records/${data.username}`);
                const records = await response.json();

                const tableBody = document.querySelector(".styled-table tbody");
                tableBody.innerHTML = ""; // Clear existing rows

                records.forEach(record => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <th class="selection"><input type="checkbox"></th>
                        <td>${record.platform}</td>
                        <td>${record.username}</td>
                        <td>
                            <input type="password" value="${record.password}" class="password-field" readonly>
                            <span class="toggle-password" onclick="togglePasswordVisibility(this)">üëÅÔ∏è</span>
                        </td>
                    `;
                    tableBody.appendChild(newRow);
                });
                hideFetchRecordsWindow(); // Hide the fetch records window after fetching
            } catch (error) {
                console.error('Error fetching records:', error);
            }
        }

        function togglePasswordVisibility(element) {
            const passwordField = element.previousElementSibling;
            if (passwordField.type === "password") {
                passwordField.type = "text";
                element.textContent = "üôà";
            } else {
                passwordField.type = "password";
                element.textContent = "üëÅÔ∏è";
            }
        }

        function hideAddRecordWindow() {
            document.querySelector('.add-wall').style.display = 'none';
        }

        function showAddRecordWindow() {
            document.querySelector('.add-wall').style.display = 'block';
        }
        function hideFetchRecordsWindow() {
            document.querySelector('.fetch-records-wall').style.display = 'none';
        }

        function showFetchRecordsWindow() {
            document.querySelector('.fetch-records-wall').style.display = 'block';
        }
    
        
    </script>
    
    
    <script src="./JS/password-view.js"></script>
</body>

</html>