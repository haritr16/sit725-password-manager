<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./css/password-view.css">
    <title>Password Manager</title>
</head>

<body>
    <div class="navigation">
        <nav class="btn-set1">
            <!-- <input class="action-btn menu-button" type="button"> -->
            <input class="action-btn add-record" type="button">
            <input class="action-btn remove-record" type="button">
            <input class="action-btn password-gen" type="button">
            <!-- <input class="action-btn fetch-records" type="button" onclick="showFetchRecordsWindow()" value="Fetch Records">         -->
            <input class="action-btn logout" type="button" onclick="confirmLogout()">
            <!-- <input class="action-btn logout" type="button" onclick="confirmLogout()">
            <input class="action-btn add-record" type="button">
            <input class="action-btn password-gen" type="button"> -->

            <!-- <input class="action-btn remove-record" type="button">
             -->
             <!-- <input class="action-btn remove-record" type="button" onclick="showDeleteRecordWindow()" value="Delete Record"> -->
            <!-- <input class="action-btn fetch-records" type="button" onclick="showFetchRecordsWindow()" value="Fetch Records"> -->
           
        </nav>
    </div>
    </div>
    <div class="table-container">
        <table class="styled-table">
            <thead>
                <tr>
                    <th class="selection">Selection</th>
                    <th>Platform</th>
                    <th>Username</th>
                    <th>Password</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="add-wall" style="display: none;">
        <div class="add-window">
            <h2>Add a record</h2>
            <form id="addRecordForm" action="/add-record" method="POST" onsubmit="return addRecord1(event)">
                <input class="add-inputs add-platform" name="platform" type="text" required placeholder="Platform" >
                <input class="add-inputs add-username" name="username_platform" type="text" required placeholder="Username" >
                <input class="add-inputs add-password" name="password" type="password" required placeholder="Password" >
                <input class="add-inputs add-retype-password" name="retypePassword" type="password" required placeholder="Re-type Password" >
                <input class="add-inputs add-submit" type="submit" value="Confirm">
                <input class="add-cancel" type="button" value="X" onclick="hideAddRecordWindow()">
            </form>
        </div>
    </div>
    <div class="delete-wall" style="display: none;">
        <div class="delete-window">
            <h2>Delete a record</h2>
            <form id="deleteRecordForm" onsubmit="return deleteRecord(event)">
                <input class="delete-inputs delete-username" name="username" type="text" required placeholder="Username">
                <input class="delete-inputs delete-username-platform" name="username_platform" type="text" required placeholder="Username (Platform)">
                <input class="delete-inputs delete-submit" type="submit" value="Delete">
                <input class="delete-cancel" type="button" value="X" onclick="hideDeleteRecordWindow()">
            </form>
        </div>
    </div>
   
    <div class="password-generator-wall">
        <div class="password-generator-window">
            <h2>Generate a Password</h2>
            <form onsubmit="return false;">
                <div class="checkbox-container">
                    <label><input type="checkbox" id="include-numbers"> Numbers</label>
                    <label><input type="checkbox" id="include-uppercase"> Capital Letters</label>
                    <label><input type="checkbox" id="include-lowercase"> Small Letters</label>
                    <label><input type="checkbox" id="include-special"> Special Characters</label>
                </div>
                <div class="range-container">
                    <label>
                        Length: <span id="password-length-value">12</span>
                        <input type="range" id="password-length" min="8" max="18" value="12" oninput="updatePasswordLengthDisplay()">
                    </label>
                </div>
                <div class="button-container">
                    <button type="button" onclick="generatePassword()">Generate</button>
                </div>
                <div class="output-container">
                    <input type="text" id="generated-password" readonly>
                    <button type="button" onclick="copyPassword()">Copy</button>
                </div>
                <button type="button" class="close-button">‚úñ</button>
            </form>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const records = JSON.parse(localStorage.getItem('records')) || [];
            const tableBody = document.querySelector(".styled-table tbody");

            records.forEach(record => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <th class="selection"><input type="checkbox"></th>
                    <td>${record.platform}</td>
                    <td>${record.username_platform}</td>
                    <td>
                        <input type="password" value="${record.password}" class="password-field" readonly>
                        <span class="toggle-password" onclick="togglePasswordVisibility(this)">üëÅÔ∏è</span>
                    </td>
                `;
                tableBody.appendChild(newRow);
            });
        });

        async function addRecord1(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            //const username = sessionStorage.getItem('username') || localStorage.getItem('username');
            //console.log(username);
         //   console.log('Form data:', data);  // Log form data for debugging

            if (data.password !== data.retypePassword) {
                alert('Passwords do not match');
                return false;
            }

            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        platform: data.platform,
                        username_platform: data.username_platform,
                        password: data.password
                    })
                });

                const result = await response.json();
              //  console.log('Server response:', result);  // Log server response for debugging

                if (response.ok) {
                    alert(result.message);
                    form.reset();
                    hideAddRecordWindow();
                    addRecordToTable(data);  // Add the new record to the table
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error adding record:', error);
                alert('An error occurred while adding the record.');
            }
        }

        function addRecordToTable(record) {
            const tableBody = document.querySelector(".styled-table tbody");
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <th class="selection"><input type="checkbox"></th>
                <td>${record.platform}</td>
                <td>${record.username_platform}</td>
                <td>
                    <input type="password" value="${record.password}" class="password-field" readonly>
                    <span class="toggle-password" onclick="togglePasswordVisibility(this)">üëÅÔ∏è</span>
                </td>
            `;
            tableBody.appendChild(newRow);
        }
        async function deleteRecord(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            console.log('Delete form data:', data);  // Log delete form data for debugging

            try {
                const response = await fetch('/delete-record', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('Delete server response:', result);  // Log delete server response for debugging

                if (response.ok) {
                    alert(result.message);
                    form.reset();
                    hideDeleteRecordWindow();
                    removeRecordFromTable(data.username_platform);  // Remove the record from the table
                    // alert('Please login again to reflect the changes.');
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error deleting record:', error);
                alert('An error occurred while deleting the record.');
            }
        }

        function removeRecordFromTable(username_platform) {
            const tableBody = document.querySelector(".styled-table tbody");
            const rows = tableBody.getElementsByTagName('tr');
            for (let row of rows) {
                const usernameCell = row.cells[2];
                if (usernameCell && usernameCell.textContent === username_platform) {
                    tableBody.removeChild(row);
                    break;
                }
            }
        }


        function togglePasswordVisibility(element) {
            const passwordField = element.previousElementSibling;
            if (passwordField.type === "password") {
                passwordField.type = "text";
                element.textContent = "üôà";
            } else {
                passwordField.type = "password";
                element.textContent = "üëÅÔ∏è";
            }
        }

        function hideAddRecordWindow() {
            document.querySelector('.add-wall').style.display = 'none';
        }

        function showAddRecordWindow() {
            document.querySelector('.add-wall').style.display = 'block';
        }
        
        function hideDeleteRecordWindow() {
            document.querySelector('.delete-wall').style.display = 'none';
        }

        function showDeleteRecordWindow() {
            document.querySelector('.delete-wall').style.display = 'block';
        }
    </script>
    
    <script src="./JS/password-view.js"></script>
</body>

</html>